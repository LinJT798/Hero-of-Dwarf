# 商店和建筑系统需求文档

## 模块概述

商店和建筑系统是游戏的经济核心，管理建筑物的购买、放置和管理，为玩家提供战略性的建筑选择和资源管理体验。

## 1. 基础设定

### 商店特点
- **常驻显示**：商店UI在游戏过程中持续显示
- **固定栏位**：商店有固定的商品栏位数量
- **配置驱动**：商店内容完全由配置文件控制

### 建筑类型
- **当前版本**：主要支持弓箭塔
- **扩展性**：支持配置文件添加更多建筑类型

## 2. 商店刷新系统

### 刷新机制
- **栏位数量**：每次刷新显示2个商品栏位
- **商品来源**：从配置文件的商品池中随机选择
- **刷新条件**：所有栏位的商品都被购买后触发刷新

### 商品配置
- **商品池**：配置文件中定义的所有可售商品
- **商品内容**：建筑物类型 + 所需资源
- **随机选择**：每次刷新随机从商品池中选择2个商品

### 刷新流程
1. **初始化**：游戏开始时从商品池随机选择2个商品
2. **购买监控**：监控商品的购买状态
3. **刷新触发**：当所有商品都被购买后触发刷新
4. **重新选择**：重新从商品池中随机选择2个商品
5. **UI更新**：更新商店显示

## 3. 购买系统

### 购买流程
1. **点击检测**：玩家点击商店中的建筑物
2. **资源检查**：检查玩家是否有足够资源
3. **资源扣除**：扣除相应资源
4. **地基创建**：在建筑位置创建地基
5. **状态更新**：将商品标记为已购买
6. **通知矮人**：通知矮人NPC进行建造

### 购买条件
- **资源充足**：玩家拥有足够的所需资源
- **位置可用**：有可用的建筑位置
- **商品可用**：商品尚未被购买

### 购买反馈
- **成功购买**：扣除资源，栏位变为已购买状态
- **资源不足**：无任何响应，保持原状态
- **位置不足**：无法建造，但可能扣除资源（需确认）

## 4. 建筑放置系统

### 放置规则
- **自动放置**：系统自动选择建筑位置
- **从左到右**：按从左到右的顺序选择位置
- **位置检查**：检查位置是否被占用

### 位置管理
- **网格系统**：地面划分为固定的建筑网格
- **占用检测**：检查网格是否已有建筑物
- **空地处理**：建筑物被摧毁后位置变为空地

### 放置流程
1. **位置扫描**：从左到右扫描可用位置
2. **位置选择**：选择第一个可用位置
3. **地基放置**：在选定位置放置地基
4. **位置标记**：标记该位置为已占用
5. **建造通知**：通知矮人NPC进行建造

### 特殊情况处理
- **位置被占用**：跳过该位置，继续向右查找
- **建筑被摧毁**：该位置重新变为可用
- **所有位置占用**：无法建造新建筑物

## 5. 商店UI系统

### 显示内容
- **建筑物图标**：显示建筑物的视觉表示
- **成本信息**：显示建造所需的资源和数量
- **状态指示**：显示是否可购买或已购买

### UI状态
- **可购买**：正常显示，可以点击
- **已购买**：灰色显示或特殊标记，无法点击
- **资源不足**：特殊视觉提示（具体根据UI设计稿）

### 交互反馈
- **点击反馈**：点击时的视觉或音效反馈
- **状态变化**：购买成功后的状态变化动画
- **资源提示**：显示所需资源的详细信息

## 6. 建筑管理系统

### 建筑限制
- **数量限制**：无建筑物数量限制
- **位置限制**：受建筑网格位置限制
- **资源限制**：受玩家资源限制

### 建筑状态
- **建造中**：地基状态，矮人正在建造
- **已完成**：建筑物建造完成，可以工作
- **已摧毁**：建筑物被摧毁，位置变为空地

### 建筑功能
- **当前版本**：不支持建筑升级和修理
- **未来扩展**：保留升级和修理功能的设计空间

## 7. 防重复购买系统

### 防重复机制
- **状态锁定**：购买成功后商品栏位锁定
- **点击屏蔽**：已购买商品无法再次点击
- **资源保护**：避免重复扣除资源

### 异常处理
- **疯狂点击**：只处理第一次有效点击
- **网络延迟**：确保购买操作的原子性
- **状态同步**：确保UI状态与游戏状态同步

## 8. 配置文件设计

### 商店配置 (shop_config.json)
```json
{
  "shop_settings": {
    "slot_count": 2,
    "auto_refresh": true,
    "refresh_on_all_purchased": true
  },
  "products": [
    {
      "id": "arrow_tower_1",
      "type": "arrow_tower",
      "name": "弓箭塔",
      "icon": "arrow_tower_icon.png",
      "cost": {
        "wood": 2,
        "stone": 1,
        "gold": 1
      },
      "weight": 10
    },
    {
      "id": "arrow_tower_2",
      "type": "arrow_tower",
      "name": "弓箭塔",
      "icon": "arrow_tower_icon.png",
      "cost": {
        "wood": 3,
        "stone": 2
      },
      "weight": 8
    }
  ]
}
```

### 建筑位置配置 (building_positions.json)
```json
{
  "grid_settings": {
    "cell_width": 80,
    "cell_height": 80,
    "start_x": 200,
    "start_y": 400
  },
  "positions": [
    {"id": 1, "x": 200, "y": 400, "occupied": false},
    {"id": 2, "x": 280, "y": 400, "occupied": false},
    {"id": 3, "x": 360, "y": 400, "occupied": false},
    {"id": 4, "x": 440, "y": 400, "occupied": false},
    {"id": 5, "x": 520, "y": 400, "occupied": false}
  ]
}
```

### 建筑属性配置 (building_properties.json)
```json
{
  "arrow_tower": {
    "build_time": 2.0,
    "max_health": 100,
    "attack_damage": 25,
    "attack_range": 120,
    "attack_speed": 1.2
  }
}
```

## 9. 技术要求

### 核心功能
- **商店管理**：商品的显示、刷新、购买
- **位置管理**：建筑位置的分配和管理
- **状态同步**：UI状态与游戏状态的同步
- **配置加载**：配置文件的读取和应用

### 数据结构
```javascript
// 商店状态
ShopState = {
  current_products: [Product],
  slot_states: ["available", "purchased"],
  refresh_ready: boolean
}

// 商品对象
Product = {
  id: string,
  type: string,
  name: string,
  icon: string,
  cost: {resource_type: amount},
  weight: number,
  purchased: boolean
}

// 建筑位置
BuildingPosition = {
  id: number,
  x: number,
  y: number,
  occupied: boolean,
  building_id: string | null
}
```

### 性能要求
- **快速响应**：购买操作响应时间 < 100ms
- **流畅刷新**：商店刷新的流畅动画
- **内存优化**：合理的商品对象管理

## 10. 测试要点

### 功能测试
- 商店刷新的正确性
- 购买流程的完整性
- 建筑放置的准确性
- 配置文件的有效性

### 边界测试
- 资源不足时的处理
- 位置不足时的处理
- 疯狂点击的处理
- 所有商品被购买后的刷新

### 用户体验测试
- 购买操作的直观性
- 状态反馈的清晰性
- 商店界面的易用性

---

*文档创建时间：2025年7月8日*
*最后更新时间：2025年7月8日*