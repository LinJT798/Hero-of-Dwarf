# 矮人NPC系统需求文档

## 模块概述

矮人NPC系统管理游戏中的矮人角色，负责资源收集、建筑建造等自动化任务，是连接资源系统和建筑系统的重要桥梁。

## 1. 基础设定

### 矮人数量
- **单一矮人**：游戏中只有一个矮人NPC
- **位置层级**：矮人在最前景层，显示在所有其他元素之上
- **移动范围**：在地面区域内活动

### 核心职责
1. **资源收集**：收集掉落在地面的资源
2. **建筑建造**：建造玩家购买的建筑物
3. **场景活跃**：空闲时保持场景活跃度

## 2. 任务系统

### 任务类型
- **建造任务**：建造玩家购买的建筑物
- **收集任务**：收集地面掉落的资源

### 任务优先级
1. **建造任务**：最高优先级
2. **收集任务**：次优先级
3. **空闲行为**：最低优先级

### 任务排队机制
- **同等级任务**：按接受时间顺序执行（先进先出）
- **高优先级任务**：立即中断低优先级任务
- **任务队列**：维护有序的任务队列

## 3. 建造系统

### 建造流程
1. **触发条件**：玩家在商店购买建筑物
2. **地基生成**：在指定建筑位置生成地基
3. **矮人移动**：矮人移动到建筑物位置
4. **建造动画**：播放建造动画（帧动画）
5. **建造完成**：动画播完后建筑物建造完毕
6. **地基移除**：移除地基，显示完整建筑

### 建造特点
- **专注性**：建造过程中矮人不执行其他任务
- **不可中断**：建造动画开始后不可中断
- **动画驱动**：建造完成时间由动画长度决定

### 建造动画
- **动画类型**：帧动画序列
- **动画内容**：矮人建造动作
- **动画时长**：可配置的建造时间
- **循环设置**：单次播放，播完即完成

## 4. 移动系统

### 移动限制
- **移动方向**：仅支持左右移动（水平移动）
- **移动范围**：限制在地面区域内
- **穿透性**：可以穿过建筑物，不受阻挡

### 移动动画
- **动画类型**：帧动画序列
- **动画内容**：矮人行走动作
- **动画循环**：循环播放
- **移动速度**：可配置参数

### 路径规划
- **直线移动**：水平方向直线移动到目标位置
- **最短路径**：选择最短的水平距离
- **无障碍物**：不需要避障算法

## 5. 收集系统

### 收集机制
- **收集目标**：地面掉落的资源
- **收集顺序**：按资源掉落时间排序（最早掉落的优先）
- **收集过程**：移动到资源位置，花费固定时间收集

### 收集流程
1. **检测资源**：自动检测地面新掉落的资源
2. **加入队列**：将资源添加到收集队列
3. **移动收集**：按顺序移动到资源位置
4. **收集动画**：播放收集动画
5. **资源入库**：将资源添加到玩家库存

### 收集配置
- **收集时间**：可配置的收集耗时
- **收集动画**：可配置的收集动画

## 6. 空闲行为系统

### 空闲状态
- **触发条件**：没有建造任务和收集任务时
- **行为模式**：随机左右移动
- **移动范围**：在地面区域内随机移动

### 随机移动
- **移动方向**：随机选择左或右
- **移动距离**：随机距离（在合理范围内）
- **移动间隔**：随机时间间隔
- **边界处理**：到达边界时转向

### 空闲动画
- **行走动画**：使用相同的移动动画
- **空闲动画**：可选的空闲站立动画

## 7. 资源管理系统

### 图片资源目录
```
assets/
├── dwarf/
│   ├── sprites/
│   │   ├── idle/          # 空闲状态图片
│   │   ├── walk/          # 行走动画帧
│   │   ├── collect/       # 收集动画帧
│   │   └── build/         # 建造动画帧
│   └── animations/
│       ├── walk.json      # 行走动画配置
│       ├── collect.json   # 收集动画配置
│       └── build.json     # 建造动画配置
```

### 动画资源管理
- **统一管理**：所有动画资源统一管理
- **配置驱动**：动画参数通过配置文件控制
- **预加载**：游戏启动时预加载所有动画资源

## 8. 配置文件设计

### 矮人配置 (dwarf_config.json)
```json
{
  "movement": {
    "speed": 100,
    "can_pass_buildings": true,
    "move_direction": "horizontal_only"
  },
  "collection": {
    "collect_time": 1.0,
    "priority": "earliest_first"
  },
  "building": {
    "build_animation_duration": 2.0,
    "interrupt_other_tasks": true
  },
  "idle": {
    "random_move_enabled": true,
    "random_move_interval": {
      "min": 2.0,
      "max": 5.0
    },
    "random_move_distance": {
      "min": 50,
      "max": 150
    }
  }
}
```

### 动画配置 (dwarf_animations.json)
```json
{
  "walk": {
    "frames": 6,
    "duration": 1.0,
    "loop": true,
    "frame_rate": 6
  },
  "collect": {
    "frames": 4,
    "duration": 1.0,
    "loop": false,
    "frame_rate": 4
  },
  "build": {
    "frames": 8,
    "duration": 2.0,
    "loop": false,
    "frame_rate": 4
  }
}
```

## 9. 技术要求

### 核心功能
- **任务队列管理**：优先级任务队列
- **状态机**：矮人行为状态管理
- **动画系统**：帧动画播放和切换
- **路径计算**：简单的水平移动路径

### 数据结构
```javascript
// 矮人状态
DwarfState = {
  position: {x, y},
  current_task: TaskType,
  task_queue: [Task],
  current_animation: AnimationType,
  is_busy: boolean
}

// 任务结构
Task = {
  type: "build" | "collect" | "idle",
  target: position | resource_id,
  priority: number,
  create_time: timestamp
}
```

### 性能要求
- **流畅移动**：60fps的移动动画
- **任务响应**：任务切换延迟 < 100ms
- **资源优化**：合理的动画资源管理

## 10. 测试要点

### 功能测试
- 任务优先级的正确性
- 建造流程的完整性
- 收集机制的准确性
- 空闲行为的随机性

### 性能测试
- 多任务切换的性能
- 动画播放的流畅性
- 内存占用的稳定性

### 用户体验测试
- 矮人行为的自然性
- 任务执行的可见性
- 动画效果的满意度

---

*文档创建时间：2025年7月8日*
*最后更新时间：2025年7月8日*