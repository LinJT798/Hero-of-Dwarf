# 塔防模块需求文档

## 模块概述

塔防模块是游戏的核心战斗系统，玩家使用连连看获得的资源建造弓箭塔，防御从右侧刷新的怪物攻击。

## 1. 基础设定

### 建筑物类型
- **当前版本**：仅支持弓箭塔
- **扩展性**：保留添加更多建筑类型的可能性

### 地图布局
- **地面结构**：单层横版地面
- **建筑区域**：地面中间部分用于建筑放置
- **怪物路径**：从右侧到左侧的直线移动
- **城堡位置**：最左边作为防御目标

## 2. 弓箭塔系统

### 建筑属性
所有属性支持配置文件调整：
- **攻击力**：对怪物造成的伤害值
- **攻击速度**：攻击间隔时间
- **射程**：攻击范围半径
- **建造成本**：所需资源数量

### 放置机制
- **放置方式**：自动放置（从左到右顺序）
- **网格限制**：地面划分为固定网格点
- **占用规则**：每个网格点只能放置一个建筑
- **位置确定**：具体网格布局根据UI设计稿确定

### 升级机制
- **当前版本**：不支持升级
- **未来扩展**：保留升级功能的设计空间

## 3. 攻击系统

### 目标选择
- **攻击策略**：自动攻击射程内最近的怪物
- **优先级**：距离优先（最近目标）
- **视野范围**：以弓箭塔为中心的圆形射程区域

### 攻击表现
- **发射动画**：弓箭塔射箭的帧动画
- **弹道效果**：箭矢飞行动画和轨迹
- **命中效果**：箭矢命中怪物的视觉反馈
- **飞行时间**：箭矢从发射到命中的时间

### 攻击特效
- **当前版本**：无特殊效果（暴击、穿透等）
- **未来扩展**：保留特殊效果的设计空间

## 4. 怪物系统

### 怪物类型
- **当前版本**：仅一种基础怪物
- **扩展性**：保留添加更多怪物类型的可能性

### 怪物属性
所有属性支持配置文件调整：
- **生命值**：怪物血量
- **移动速度**：从右到左的移动速度
- **攻击力**：对建筑物造成的伤害
- **防御力**：减少受到的伤害（可选）

### 移动机制
- **移动路径**：严格从右到左直线移动
- **路径固定**：不支持路径变化或绕行
- **目标明确**：直接攻击城堡

## 5. 战斗机制

### 建筑物生命值
- **血量系统**：弓箭塔具有生命值
- **攻击承受**：怪物可以攻击和摧毁建筑物
- **摧毁处理**：
  - 播放摧毁动画（帧动画）
  - 建筑物消失，释放网格占用
  - 不掉落资源或残骸

### 战斗流程
1. 怪物从右侧生成，向左移动
2. 弓箭塔自动检测射程内怪物
3. 发射箭矢，播放发射动画
4. 箭矢飞行，播放飞行动画
5. 命中怪物，造成伤害
6. 怪物死亡或继续移动
7. 怪物攻击阻挡的建筑物

### 战斗反馈
- **当前版本**：暂不需要伤害数字等反馈
- **未来扩展**：保留战斗反馈的设计空间

## 6. 动画系统

### 帧动画处理
所有动画采用帧动画方式：
- **弓箭塔射箭动画**：发射动作序列帧
- **箭矢飞行动画**：飞行轨迹和旋转
- **怪物移动动画**：行走动作序列帧
- **建筑摧毁动画**：爆炸或倒塌效果
- **怪物死亡动画**：死亡动作序列帧

### 动画配置
- **帧率设置**：支持配置文件调整
- **动画时长**：各动画持续时间可配置
- **循环设置**：动画循环或单次播放

## 7. 配置文件设计

### 弓箭塔配置 (tower_config.json)
```json
{
  "arrow_tower": {
    "attack_damage": 10,
    "attack_speed": 1.0,
    "attack_range": 100,
    "build_cost": {
      "wood": 2,
      "stone": 1
    },
    "health": 50
  }
}
```

### 怪物配置 (monster_config.json)
```json
{
  "basic_monster": {
    "health": 30,
    "move_speed": 50,
    "attack_damage": 15,
    "defense": 0
  }
}
```

### 战斗配置 (combat_config.json)
```json
{
  "arrow_flight_speed": 200,
  "damage_calculation": "direct",
  "targeting_priority": "nearest"
}
```

### 动画配置 (animation_config.json)
```json
{
  "tower_shoot": {
    "frames": 4,
    "duration": 0.5,
    "loop": false
  },
  "monster_walk": {
    "frames": 6,
    "duration": 1.0,
    "loop": true
  },
  "building_destroy": {
    "frames": 8,
    "duration": 1.2,
    "loop": false
  }
}
```

## 8. 技术要求

### 核心功能
- **碰撞检测**：射程判断和命中检测
- **路径计算**：箭矢飞行轨迹
- **状态管理**：建筑物和怪物状态
- **动画管理**：帧动画播放和切换

### 性能要求
- **流畅战斗**：60fps的战斗画面
- **响应及时**：攻击判断延迟 < 50ms
- **内存优化**：合理的对象池管理

### 扩展性要求
- **模块化设计**：便于添加新建筑类型
- **配置驱动**：所有数值可配置调整
- **动画系统**：统一的帧动画管理

## 9. 测试要点

### 功能测试
- 建筑放置的正确性
- 攻击判断的准确性
- 动画播放的流畅性
- 配置文件的有效性

### 性能测试
- 多个建筑同时攻击的性能
- 大量怪物时的帧率稳定性
- 内存占用的合理性

### 平衡性测试
- 建筑攻击力与怪物血量的平衡
- 攻击速度与怪物移动速度的平衡
- 建造成本与收益的平衡

---

*文档创建时间：2025年7月8日*
*最后更新时间：2025年7月8日*