# 怪物和战斗系统需求文档

## 模块概述

怪物和战斗系统是游戏的核心挑战机制，管理怪物生成、移动、攻击和死亡等行为，为玩家提供紧张刺激的塔防体验。

## 1. 基础设定

### 怪物类型
- **当前版本**：仅支持一种基础怪物
- **扩展性**：保留添加更多怪物类型的设计空间

### 怪物目标
- **主要目标**：攻击最左边的城堡
- **次要目标**：攻击路径上的建筑物
- **移动路径**：从右到左严格直线移动

## 2. 怪物生成系统

### 生成机制
- **生成方式**：按波次生成
- **生成数量**：每波次可同时生成多个怪物
- **生成位置**：固定的生成点（右侧区域）
- **生成时机**：根据关卡配置的波次时间表

### 波次配置
- **波次间隔**：可配置的波次间隔时间
- **怪物数量**：每波次生成的怪物数量
- **生成延迟**：同一波次内怪物的生成间隔

### 生成流程
1. **波次触发**：根据时间表触发新波次
2. **怪物创建**：在固定位置创建指定数量的怪物
3. **初始化**：设置怪物属性和状态
4. **开始移动**：怪物开始向左移动

## 3. 怪物移动系统

### 移动特点
- **移动方向**：严格从右到左水平移动
- **移动速度**：恒定速度，不会变化
- **移动路径**：直线路径，无路径规划
- **移动限制**：不会绕行或改变路径

### 移动动画
- **动画类型**：帧动画序列
- **动画内容**：怪物行走动作
- **动画循环**：循环播放
- **动画同步**：动画速度与移动速度同步

### 移动处理
- **边界检测**：到达城堡位置的检测
- **碰撞检测**：与建筑物的碰撞检测
- **路径阻挡**：遇到建筑物时停止移动

## 4. 怪物攻击系统

### 攻击方式
- **攻击类型**：近战攻击
- **攻击目标**：路径上的建筑物和城堡
- **攻击触发**：接触到目标时开始攻击

### 攻击属性
所有属性支持配置文件调整：
- **攻击力**：对建筑物造成的伤害值
- **攻击速度**：攻击间隔时间
- **攻击范围**：近战攻击范围（接触距离）

### 攻击动画
- **动画类型**：帧动画序列
- **动画内容**：怪物攻击动作
- **动画时长**：可配置的攻击动画时间
- **动画循环**：单次播放，完成后可重复

### 攻击流程
1. **接触检测**：怪物移动到建筑物位置
2. **停止移动**：停止向前移动
3. **攻击动画**：播放攻击动画
4. **造成伤害**：对建筑物造成伤害
5. **攻击间隔**：等待攻击冷却时间
6. **重复攻击**：直到建筑物被摧毁

## 5. 怪物死亡系统

### 死亡条件
- **生命值归零**：受到攻击后血量降为0
- **死亡即时**：满足条件时立即死亡

### 死亡处理
- **死亡动画**：播放死亡动画（帧动画）
- **资源掉落**：有概率掉落资源到地面
- **对象销毁**：死亡动画播放完毕后直接消失
- **无残留**：不留下尸体或其他残留物

### 资源掉落
- **掉落概率**：可配置的掉落几率
- **掉落类型**：随机掉落各种资源
- **掉落权重**：不同资源的掉落权重
- **掉落位置**：怪物死亡位置

## 6. 战斗反馈系统

### 受击反馈
- **击退效果**：怪物受到攻击时有轻微击退
- **击退距离**：短距离的向后位移
- **击退时间**：瞬间或短暂的击退动画
- **视觉反馈**：受击时的闪烁或颜色变化

### 血量系统
- **血量显示**：不显示血量条或血量数字
- **内部计算**：血量仅用于内部计算
- **死亡判断**：血量归零时触发死亡

### 战斗特效
- **当前版本**：暂时不添加复杂特效
- **未来扩展**：保留添加战斗特效的设计空间

## 7. 关卡配置系统

### 关卡设定
- **关卡独立**：每个关卡有独立的怪物配置
- **强度固定**：怪物强度不递增，保持固定
- **波次配置**：每个关卡的波次数量和时间可配置

### 胜利条件
- **时间生存**：在关卡时间内存活
- **击败所有怪物**：成功防御所有怪物波次
- **城堡保护**：城堡血量不归零

### 失败条件
- **城堡被摧毁**：怪物攻破城堡
- **防线崩溃**：无法有效防御怪物

## 8. 配置文件设计

### 怪物配置 (monster_config.json)
```json
{
  "basic_monster": {
    "health": 50,
    "move_speed": 60,
    "attack_damage": 20,
    "attack_speed": 1.5,
    "attack_range": 5,
    "knockback_distance": 10,
    "knockback_duration": 0.2,
    "death_drop_chance": 0.3,
    "death_drop_resources": {
      "gold": 0.4,
      "wood": 0.3,
      "stone": 0.2,
      "food": 0.1
    }
  }
}
```

### 波次配置 (wave_config.json)
```json
{
  "level_1": {
    "waves": [
      {
        "wave_id": 1,
        "start_time": 10.0,
        "monster_count": 3,
        "spawn_interval": 1.0,
        "monster_type": "basic_monster"
      },
      {
        "wave_id": 2,
        "start_time": 30.0,
        "monster_count": 5,
        "spawn_interval": 0.8,
        "monster_type": "basic_monster"
      }
    ],
    "total_duration": 120.0
  }
}
```

### 战斗配置 (combat_config.json)
```json
{
  "damage_calculation": {
    "type": "direct",
    "armor_reduction": false
  },
  "effects": {
    "knockback_enabled": true,
    "hit_flash_enabled": true,
    "hit_flash_duration": 0.1
  },
  "spawn_settings": {
    "spawn_position": {
      "x": 800,
      "y": 400
    },
    "spawn_variation": 20
  }
}
```

## 9. 技术要求

### 核心功能
- **怪物管理**：怪物对象的创建、更新、销毁
- **波次控制**：波次时间表的管理和执行
- **碰撞检测**：怪物与建筑物的碰撞检测
- **战斗计算**：伤害计算和生命值管理

### 数据结构
```javascript
// 怪物对象
Monster = {
  id: unique_id,
  type: "basic_monster",
  position: {x, y},
  health: current_health,
  max_health: max_health,
  move_speed: speed,
  state: "moving" | "attacking" | "dying",
  target: building_id | "castle",
  attack_cooldown: time_remaining
}

// 波次数据
Wave = {
  wave_id: number,
  start_time: timestamp,
  monster_count: number,
  spawned_count: number,
  spawn_interval: time,
  monster_type: string,
  active: boolean
}
```

### 性能要求
- **多怪物处理**：支持同时处理多个怪物
- **流畅动画**：60fps的移动和攻击动画
- **内存优化**：合理的对象池管理

## 10. 测试要点

### 功能测试
- 怪物生成的准确性
- 移动和攻击的正确性
- 死亡和掉落的有效性
- 配置文件的正确性

### 性能测试
- 多怪物同时活动的性能
- 战斗计算的效率
- 内存使用的稳定性

### 平衡性测试
- 怪物强度与防御建筑的平衡
- 波次难度的合理性
- 资源掉落的经济平衡

---

*文档创建时间：2025年7月8日*
*最后更新时间：2025年7月8日*